// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider   = "prisma-client-js"
  engineType = "client"
}

datasource db {
  provider = "postgresql"
}

model User {
  id            String   @id @default(cuid())
  email         String   @unique
  password      String
  name          String
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt
  
  // Referral system
  referralCode  String?  @unique            // Unique code for sharing (generated on first access)
  referredById  String?                             // Who referred this user
  referredBy    User?    @relation("UserReferrals", fields: [referredById], references: [id])
  referrals     User[]   @relation("UserReferrals") // Users this user referred
  
  // Referral rewards
  referralPoints    Int      @default(0)   // Total points earned
  referralEarnings  Float    @default(0)   // Total $ earned from referrals
  referralCardCount Int      @default(0)   // Number of successful card referrals
  
  cards         Card[]
  sessions      Session[]
  payments      Payment[]
  apiKeys       ApiKey[]
  referralLogs  ReferralLog[]  // Logs of referral rewards earned
}

model ReferralLog {
  id            String   @id @default(cuid())
  
  // Who earned the reward
  referrerId    String
  referrer      User     @relation(fields: [referrerId], references: [id], onDelete: Cascade)
  
  // Who was referred (the new user who made a card)
  referredEmail String   // Email of the person who signed up + created card
  
  // Reward details
  rewardAmount  Float    @default(5)   // $5 reward
  points        Int      @default(10)  // Points earned
  
  // What triggered it
  cardId        String   // The card that was successfully created
  paymentId     String   // The payment that was completed
  
  // Status
  status        String   @default("CREDITED")  // CREDITED, PENDING, etc.
  
  createdAt     DateTime @default(now())

  @@index([referrerId])
  @@index([createdAt])
}

model Card {
  id              String   @id @default(cuid())
  
  // KripiCard API fields
  kripiCardId     String?  @unique  // The card_id from KripiCard API (null for pending cards)
  cardNumber      String   @default("")  // Masked or full card number
  expiryDate      String   @default("")
  cvv             String   @default("")
  nameOnCard      String
  bankBin         String   @default("49387519")
  
  // Card status
  balance         Float    @default(0)
  status          CardStatus @default(ACTIVE)
  
  // Ownership
  userId          String
  user            User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  // Relations
  transactions    CardTransaction[]
  
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  @@index([userId])
}

model Session {
  id        String   @id @default(cuid())
  token     String   @unique
  userId    String
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  expiresAt DateTime
  createdAt DateTime @default(now())

  @@index([userId])
  @@index([token])
}

enum CardStatus {
  PENDING
  ACTIVE
  FROZEN
  CANCELLED
}

model Payment {
  id              String        @id @default(cuid())
  
  // Payment details
  amountUsd       Float         // Total amount to pay in USD (including fees)
  amountSol       Float         // Amount to pay in SOL
  solPriceAtTime  Float         // SOL/USD price when payment was created
  
  // For topups: track the actual topup amount vs fees
  topupAmount     Float?        // Actual topup amount (before fees)
  topupFee        Float?        // Fee charged for topup (2.5% + $1)
  
  // Transaction tracking
  txSignature     String?       // Solana transaction signature
  senderWallet    String?       // Wallet address that sent the payment
  status          PaymentStatus @default(PENDING)
  
  // Card details (for after payment is verified)
  cardType        String        @default("issue")  // "issue" or "topup"
  nameOnCard      String?
  targetCardId    String?       // For topups - the card to fund
  
  // Ownership
  userId          String
  user            User          @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  // Resulting card (once issued)
  issuedCardId    String?
  
  createdAt       DateTime      @default(now())
  updatedAt       DateTime      @updatedAt
  expiresAt       DateTime      // Payment expires after some time

  @@index([userId])
  @@index([status])
  @@index([txSignature])
  @@index([senderWallet])
}

enum PaymentStatus {
  PENDING     // Waiting for payment
  CONFIRMING  // Payment detected, confirming
  VERIFIED    // Payment verified
  COMPLETED   // Card issued/funded
  EXPIRED     // Payment window expired
  FAILED      // Payment failed
}

model CardTransaction {
  id              String   @id @default(cuid())
  
  // Transaction details
  cardId          String
  card            Card     @relation(fields: [cardId], references: [id], onDelete: Cascade)
  
  // Transaction info
  type            TransactionType  // FUND, SPEND, FREEZE, UNFREEZE, etc
  amount          Float
  description     String   @default("")
  
  // Transaction status
  status          String   @default("COMPLETED")  // COMPLETED, PENDING, FAILED
  
  // External transaction ID (from KripiCard if applicable)
  externalTxId    String?
  
  // Metadata
  metadata        String?  // JSON string for additional data
  
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  @@index([cardId])
  @@index([createdAt])
}

enum TransactionType {
  FUND      // Added funds via Solana payment
  SPEND     // Card was used to make a purchase
  FREEZE    // Card was frozen
  UNFREEZE  // Card was unfrozen
  REFUND    // Transaction refund
  BALANCE_SYNC  // Balance synced from KripiCard
}

// ============================================
// PrivatePay API Product Models
// ============================================

model ApiKey {
  id            String       @id @default(cuid())
  
  // Key info
  key           String       @unique  // ppay_live_xxxx or ppay_test_xxxx
  name          String       @default("Default")
  hashedKey     String       // SHA-256 hash for lookup
  
  // Owner
  userId        String
  user          User         @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  // Plan & limits
  planId        String
  plan          ApiPlan      @relation(fields: [planId], references: [id])
  
  // Status
  isActive      Boolean      @default(true)
  isTest        Boolean      @default(false)  // Test mode key
  
  // Rate limiting
  rateLimit     Int          @default(100)     // Requests per minute
  monthlyLimit  Int          @default(1000)    // Cards per month
  
  // Wallet â€” developer must deposit funds before issuing cards
  walletBalance Float        @default(0)       // Available balance in USD
  totalDeposited Float       @default(0)       // Lifetime deposits
  totalCharged  Float        @default(0)       // Lifetime charges (card fees + markup)
  
  // Usage tracking
  totalRequests Int          @default(0)
  totalCards    Int          @default(0)
  totalVolume   Float        @default(0)       // Total USD card load volume
  
  // Metadata
  allowedIps    String?      // Comma-separated IPs (null = all)
  webhookUrl    String?      // Webhook for events
  webhookSecret String?      // HMAC secret for webhook signatures
  
  // Relations
  usage         ApiUsage[]
  apiCards      ApiCard[]
  transactions  ApiTransaction[]
  
  lastUsedAt    DateTime?
  createdAt     DateTime     @default(now())
  updatedAt     DateTime     @updatedAt

  @@index([hashedKey])
  @@index([userId])
  @@index([planId])
}

model ApiPlan {
  id              String    @id @default(cuid())
  
  // Plan details
  name            String    @unique  // "starter", "growth", "enterprise"
  displayName     String               // "Starter", "Growth", "Enterprise"
  priceMonthly    Float                // One-time access fee in USD
  
  // Limits
  cardsPerMonth   Int                  // Max cards per month
  requestsPerMin  Int                  // Rate limit
  
  // Fees (charged per card on top of subscription)
  cardIssueFee    Float                // Fee per card issued
  cardFundFee     Float                // Fee per funding operation
  markupPercent   Float     @default(0) // Markup on card load amount
  
  // Features
  liveCards       Boolean   @default(true)
  testMode        Boolean   @default(true)
  webhooks        Boolean   @default(false)
  ipWhitelist     Boolean   @default(false)
  prioritySupport Boolean   @default(false)
  dedicatedBin    Boolean   @default(false)
  customBranding  Boolean   @default(false)
  
  // Relations
  apiKeys         ApiKey[]
  
  isActive        Boolean   @default(true)
  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt
}

model ApiUsage {
  id            String   @id @default(cuid())
  
  // Tracking
  apiKeyId      String
  apiKey        ApiKey   @relation(fields: [apiKeyId], references: [id], onDelete: Cascade)
  
  // Usage details
  endpoint      String   // "/v1/cards", "/v1/cards/:id/fund", etc.
  method        String   // "POST", "GET", etc.
  statusCode    Int      // HTTP response code
  responseTime  Int      // ms
  
  // Request info
  ipAddress     String?
  userAgent     String?
  
  createdAt     DateTime @default(now())

  @@index([apiKeyId])
  @@index([createdAt])
  @@index([apiKeyId, createdAt])
}

model ApiTransaction {
  id            String             @id @default(cuid())
  
  apiKeyId      String
  apiKey        ApiKey             @relation(fields: [apiKeyId], references: [id], onDelete: Cascade)
  
  type          ApiTransactionType
  amount        Float              // Positive = credit, displayed as absolute
  balanceAfter  Float              // Balance after this transaction
  description   String             // "Deposit via Solana", "Card issuance fee", etc.
  reference     String?            // tx hash, card ID, etc.
  
  createdAt     DateTime           @default(now())

  @@index([apiKeyId])
  @@index([createdAt])
}

enum ApiTransactionType {
  DEPOSIT       // Developer adds funds to wallet
  CARD_ISSUE    // Fee charged when issuing a card
  CARD_FUND     // Fee charged when funding a card
  CARD_LOAD     // Actual card load amount (goes to KripiCard)
  REFUND        // Refund back to wallet
  ADJUSTMENT    // Manual admin adjustment
}

model ApiCard {
  id              String   @id @default(cuid())
  
  // API key that created this card
  apiKeyId        String
  apiKey          ApiKey   @relation(fields: [apiKeyId], references: [id], onDelete: Cascade)
  
  // KripiCard mapping
  kripiCardId     String?  @unique
  
  // Card details (encrypted in prod)
  cardNumber      String   @default("")
  expiryDate      String   @default("")
  cvv             String   @default("")
  nameOnCard      String
  
  // Status
  balance         Float    @default(0)
  status          CardStatus @default(ACTIVE)
  
  // External reference (customer's own ID)
  externalId      String?
  metadata        String?  // JSON string
  
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  @@index([apiKeyId])
  @@index([externalId])
}


